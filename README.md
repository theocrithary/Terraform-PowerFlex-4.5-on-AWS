# Powerflex AWS automation
This project will deploy APEX Block Storage (aka. PowerFlex) in AWS using Terraform based infrastructure as code and some manual steps that are required post deployment. 
This was tested using a RHEL 8 Linux server and may require small tweaks to the code depending on which OS you are using to run the Terraform deployment.

## Install Terraform
- https://developer.hashicorp.com/terraform/downloads
* e.g. RHEL
```
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
sudo yum -y install terraform
```

## Install AWS CLI
```
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

## Configure AWS creds
```
aws configure
```
provide access key ID and secret access key
enter default region name (e.g. eu-west-1)
enter default output format (e.g. json)

## Clone the repo
```
git clone https://github.com/theocrithary/Terraform-PowerFlex-4.5-on-AWS.git
```

## Navigate to the working directory
```
cd Terraform-PowerFlex-4.5-on-AWS/provision/deployments/vpn-mode
```

## Rename the vars.tf.example file to vars.tf
```
mv vars-example.tf vars.tf
```

## Edit the vars.tf file and replace any variables with your own environment variables
```
vi vars.tf
```

### terraform init
```
terraform init
```

### terraform validate & plan
```
terraform validate && terraform plan
```

### terraform apply
```
terraform apply -auto-approve
```

### Copy the SSH keys and SSH to the installer instance
- Retrieve the IP address of the deployed installer instance by logging into the AWS console
- Copy the SSH key to the installer instance by using the ec2-user and key generated by the Terraform scripts
- SSH to the installer instance
```
cd ../../../keys/
scp -i "powerflex-denver-key" powerflex-denver-key ec2-user@172.26.2.61:/home/ec2-user/
ssh -i "powerflex-denver-key" ec2-user@172.26.2.61
```

### Copy the SSH key to all storage nodes

```
chmod 400 powerflex-denver-key
cp powerflex-denver-key .ssh/id_rsa
```
- Retrieve the IP addresses of all co-res storage nodes from the AWS console
- Copy the SSH key to each co-res storage node
```
scp .ssh/id_rsa ec2-user@172.26.2.46:.ssh/id_rsa
scp .ssh/id_rsa ec2-user@172.26.2.110:.ssh/id_rsa
scp .ssh/id_rsa ec2-user@172.26.2.172:.ssh/id_rsa
scp .ssh/id_rsa ec2-user@172.26.2.9:.ssh/id_rsa
scp .ssh/id_rsa ec2-user@172.26.2.68:.ssh/id_rsa
scp .ssh/id_rsa ec2-user@172.26.2.179:.ssh/id_rsa
```

### Prepare the JSON file for installer setup
- Retrieve the DNS of the load balancer from the AWS console
e.g. theocrithary-20240515T000419-1431912f01fdc4ab.elb.eu-west-1.amazonaws.com
- Retrieve one of the IP's by resolving the DNS name
```
dig +short theocrithary-20240516T234716-b327a37da6a9dd23.elb.eu-west-1.amazonaws.com | head -1
```
- Prepare the JSON file as per below and replace the "Nodes" hostname and IP with the co-res instances 1-3
```

{
    "Nodes":
    [
      {
        "hostname": "ip-172-26-2-46.eu-west-1.compute.internal",
        "ipaddress": "172.26.2.46"
      },
      {
        "hostname": "ip-172-26-2-110.eu-west-1.compute.internal",
        "ipaddress": "172.26.2.110"
      },
      {
        "hostname": "ip-172-26-2-172.eu-west-1.compute.internal",
        "ipaddress": "172.26.2.172"
      }
    ],
 
    "ClusterReservedIPPoolCIDR" : "10.42.0.0/23",
 
    "ServiceReservedIPPoolCIDR" : "10.43.0.0/23",
 
    "RoutableIPPoolCIDR" : [
	  {
	    "mgmt":"10.240.126.0/25"
	  }
    ],
    
    "PFMPHostname" : "172.26.2.10",
  
    "PFMPHostIP" : "172.26.2.10"
}



### Run the installer setup and install scripts
- Edit the JSON file and replace with the pre-prepared JSON file as per above
```
sudo vi /tmp/bundle/pfmp_deployments/PFMP*/PFMP_Installer/config/PFMP_Config.json
```
- Run the setup script
```
sudo /tmp/bundle/pfmp_deployments/PFMP*/PFMP_Installer/scripts/setup_installer.sh
```
- Copy the SSH key to the installer inventory directory
```
sudo cp ~/.ssh/id_rsa /tmp/bundle/pfmp_deployments/PFMP*/atlantic/inventory
```
- Run the installer script
```
sudo /tmp/bundle/pfmp_deployments/PFMP*/PFMP_Installer/scripts/install_PFMP.sh aws
```
- Answer the prompts as follows;
```
Are ssh keys used for authentication connecting to the cluster nodes[Y]?:y
Please enter the ssh username for the nodes specified in the PFMP_Config.json[root]:ec2-user
Are ssh keys the same for all the cluster nodes[Y]?:y
Please enter the location of the ssh key for the nodes specified in the PFMP_Config.json[id_rsa]:id_rsa
Are the nodes used for the PFMP cluster, co-res nodes [Y]?:y
```


```
sudo growpart /dev/nvme0n1 3
sudo resize2fs /dev/nvme0n1p3
```


